name: Notifications

on:
  workflow_run:
    workflows: ["Auto Deploy & CI/CD", "Flutter CI", "Build and Publish Docker Image"]
    types:
      - completed
  workflow_dispatch:

jobs:
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Get workflow run details
        id: workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });
            
            core.setOutput('name', run.data.name);
            core.setOutput('status', run.data.status);
            core.setOutput('conclusion', run.data.conclusion);
            core.setOutput('html_url', run.data.html_url);
            core.setOutput('head_branch', run.data.head_branch);
            core.setOutput('head_sha', run.data.head_sha.substring(0, 7));

      - name: Create status summary
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const name = '${{ steps.workflow.outputs.name }}';
            const status = '${{ steps.workflow.outputs.status }}';
            const conclusion = '${{ steps.workflow.outputs.conclusion }}';
            const html_url = '${{ steps.workflow.outputs.html_url }}';
            const head_branch = '${{ steps.workflow.outputs.head_branch }}';
            const head_sha = '${{ steps.workflow.outputs.head_sha }}';
            
            const emoji = conclusion === 'success' ? '✅' : conclusion === 'failure' ? '❌' : '⚠️';
            const statusText = conclusion === 'success' ? 'Réussi' : conclusion === 'failure' ? 'Échoué' : 'Annulé';
            
            const summary = `## ${emoji} ${name} - ${statusText}
            
            **Branche**: \`${head_branch}\`
            **Commit**: \`${head_sha}\`
            **Statut**: ${status}
            **Conclusion**: ${conclusion}
            
            [Voir les détails](${html_url})`;
            
            core.setOutput('summary', summary);

      - name: Comment on PR if exists
        if: github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const name = '${{ steps.workflow.outputs.name }}';
            const conclusion = '${{ steps.workflow.outputs.conclusion }}';
            const html_url = '${{ steps.workflow.outputs.html_url }}';
            const head_branch = '${{ steps.workflow.outputs.head_branch }}';
            const head_sha = '${{ steps.workflow.outputs.head_sha }}';
            
            const emoji = conclusion === 'success' ? '✅' : conclusion === 'failure' ? '❌' : '⚠️';
            
            // Trouver le PR associé
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${head_branch}`
            });
            
            if (prs.data.length > 0) {
              const pr = prs.data[0];
              const comment = `## ${emoji} ${name}
              
              **Statut**: ${conclusion === 'success' ? '✅ Réussi' : '❌ Échoué'}
              **Commit**: \`${head_sha}\`
              
              [Voir les détails](${html_url})`;
              
              github.rest.issues.createComment({
                issue_number: pr.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

