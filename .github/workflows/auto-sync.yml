name: ðŸ”„ Synchronisation Automatique

on:
  schedule:
    # ExÃ©cute tous les jours Ã  2h du matin (UTC)
    - cron: '0 2 * * *'
  workflow_dispatch: # Permet de dÃ©clencher manuellement
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'

jobs:
  sync:
    name: ðŸ”„ Synchronisation GitHub
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ”§ Configuration Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: ðŸ” VÃ©rification des changements
        id: check
        run: |
          git fetch origin
          LOCAL=$(git rev-parse HEAD)
          REMOTE=$(git rev-parse origin/main)
          
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Changements dÃ©tectÃ©s"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Aucun changement"
          fi

      - name: ðŸ”„ Synchronisation automatique
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git pull origin main --rebase || true
          git push origin main || true

      - name: ðŸ“ CrÃ©ation d'un commit de synchronisation
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git add -A || true
          git commit -m "ðŸ”„ Synchronisation automatique - $(date +'%Y-%m-%d %H:%M:%S UTC')" || true
          git push origin main || true

      - name: ðŸ“Š Rapport de synchronisation
        if: always()
        run: |
          echo "## ðŸ“Š Rapport de Synchronisation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branche**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.has_changes }}" == "true" ]; then
            echo "- **Statut**: âœ… SynchronisÃ©" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Statut**: â„¹ï¸ Aucun changement" >> $GITHUB_STEP_SUMMARY
          fi

